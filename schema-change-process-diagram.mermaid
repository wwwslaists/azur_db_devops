graph TB
    subgraph "1. Test Database - Schema IzmaiÅ†as"
        DEV[ğŸ‘¨â€ğŸ’» Developer/DBA]
        CHANGE[ğŸ”§ Schema Change<br/>CREATE/ALTER/DROP<br/>Table, Procedure, View]
        DEV -->|Veic izmaiÅ†as| CHANGE
    end

    subgraph "2. Azure SQL - Change Capture"
        TRIGGER[âš¡ DDL Trigger<br/>trg_CaptureSchemaChanges]
        LOG[(ğŸ“‹ SchemaChangeLog<br/>Tabula)]
        EVENTDATA[ğŸ“„ EVENTDATA XML<br/>ObjectName<br/>ChangeType<br/>SQLCommand]
        
        CHANGE -->|AktivizÄ“| TRIGGER
        TRIGGER -->|Izvelk datus| EVENTDATA
        EVENTDATA -->|INSERT| LOG
    end

    subgraph "3. Polling Mechanism - Azure Function / Automation"
        TIMER[â° Timer Trigger<br/>Katras 2-5 min]
        POLL[ğŸ” Poll Check<br/>usp_GetUnprocessedSchemaChanges]
        CHECK{Ir neapstrÄdÄtas<br/>izmaiÅ†as?}
        
        TIMER -->|AktivizÄ“| POLL
        LOG -.->|Query| POLL
        POLL --> CHECK
    end

    subgraph "4. Change Processing"
        PARSE[ğŸ“Š Parse Changes<br/>Izveidot summary]
        VALIDATE[âœ… Validate<br/>Check risky changes]
        PREP[ğŸ“¦ Prepare Payload<br/>JSON with change details]
        
        CHECK -->|JÄ| PARSE
        PARSE --> VALIDATE
        VALIDATE --> PREP
    end

    subgraph "5. Azure DevOps - Pipeline Trigger"
        API[ğŸŒ REST API Call<br/>POST /pipelines/{id}/runs]
        QUEUE[ğŸ“¥ Pipeline Queue]
        START[â–¶ï¸ Pipeline Start]
        
        PREP -->|HTTP POST| API
        API --> QUEUE
        QUEUE --> START
    end

    subgraph "6. Pipeline Execution Stages"
        STAGE1[ğŸ“‹ Stage: Validate<br/>Display changes<br/>Check for risks]
        STAGE2[ğŸ”¨ Stage: Build<br/>Build DACPAC<br/>from source]
        STAGE3[ğŸš€ Stage: Deploy<br/>SqlAzureDacpacDeployment<br/>to Test DB]
        STAGE4[âœ”ï¸ Stage: Verify<br/>Post-deploy checks]
        
        START --> STAGE1
        STAGE1 -->|Success| STAGE2
        STAGE2 -->|DACPAC ready| STAGE3
        STAGE3 -->|Deployed| STAGE4
    end

    subgraph "7. Post-Deployment"
        RUNID[ğŸ†” Pipeline Run ID<br/>Returned from API]
        UPDATE[ğŸ’¾ Update Database<br/>usp_MarkSchemaChangesProcessed]
        MARK[âœ… Mark as Processed<br/>Set Processed=1<br/>Set PipelineRunId]
        
        STAGE4 -->|Complete| RUNID
        RUNID --> UPDATE
        UPDATE --> MARK
        MARK -.->|UPDATE| LOG
    end

    subgraph "8. Monitoring & Alerts"
        INSIGHTS[ğŸ“Š Application Insights<br/>Logs & Metrics]
        ALERT[ğŸ”” Alerts<br/>If errors > threshold]
        DASH[ğŸ“ˆ Dashboard<br/>Change statistics]
        
        POLL -.->|Log events| INSIGHTS
        API -.->|Log trigger| INSIGHTS
        STAGE3 -.->|Log deployment| INSIGHTS
        INSIGHTS -->|Monitor| ALERT
        LOG -.->|Query| DASH
    end

    subgraph "9. Error Handling"
        FAIL1{Pipeline<br/>Failed?}
        FAIL2{Connection<br/>Error?}
        RETRY[ğŸ”„ Retry Logic]
        NOTIFY[ğŸ“§ Notify Team]
        
        STAGE3 --> FAIL1
        POLL --> FAIL2
        FAIL1 -->|Yes| RETRY
        FAIL2 -->|Yes| RETRY
        RETRY --> NOTIFY
        RETRY -.->|Retry later| TIMER
    end

    CHECK -->|NÄ“| TIMER
    
    style DEV fill:#e1f5ff
    style CHANGE fill:#fff3e0
    style TRIGGER fill:#f3e5f5
    style LOG fill:#e8f5e9
    style TIMER fill:#fff9c4
    style CHECK fill:#ffebee
    style API fill:#e0f2f1
    style STAGE3 fill:#fce4ec
    style MARK fill:#c8e6c9
    style INSIGHTS fill:#e3f2fd
    style ALERT fill:#ffccbc
